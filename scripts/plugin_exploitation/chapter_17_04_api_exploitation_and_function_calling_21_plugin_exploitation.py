#!/usr/bin/env python3
"""
Defense: Function call validation

Source: Chapter_17_04_API_Exploitation_and_Function_Calling
Category: plugin_exploitation
"""

import argparse
import sys

class SecureFunctionCaller:
    """Validate and sanitize function calls"""

    def __init__(self):
        self.function_permissions = {
            'send_email': {
                'allowed_domains': ['company.com'],
                'max_recipients': 5
            },
            'query_database': {
                'allowed_tables': ['public_data'],
                'max_rows': 100
            }
        }

    def validate_function_call(self, function_name, arguments):
        """Validate function call before execution"""

        if function_name == 'send_email':
            return self.validate_email_call(arguments)
        elif function_name == 'query_database':
            return self.validate_database_call(arguments)

        return False

    def validate_email_call(self, args):
        """Validate email function call"""
        # Check recipient domain
        recipient = args.get('to', '')
        domain = recipient.split('@')[-1]

        if domain not in self.function_permissions['send_email']['allowed_domains']:
            raise SecurityError(f"Email to {domain} not allowed")

        # Check for data exfiltration patterns
        body = args.get('body', '')
        if 'SELECT' in body.upper() or 'password' in body.lower():
            raise SecurityError("Suspicious email content detected")

        return True

    def validate_database_call(self, args):
        """Validate database query"""
        query = args.get('query', '')

        # Only allow SELECT
        if not query.strip().upper().startswith('SELECT'):
            raise SecurityError("Only SELECT queries allowed")

        # Check table access
        allowed_tables = self.function_permissions['query_database']['allowed_tables']
        # Parse and validate tables (simplified)

        return True


def main():
    """Command-line interface."""
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--verbose", "-v", action="store_true", help="Verbose output")
    args = parser.parse_args()
    
    # TODO: Add main execution logic
    pass

if __name__ == "__main__":
    main()