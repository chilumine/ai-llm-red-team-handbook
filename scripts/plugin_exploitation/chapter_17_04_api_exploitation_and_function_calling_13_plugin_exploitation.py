#!/usr/bin/env python3
"""
Mass assignment vulnerabilities

Source: Chapter_17_04_API_Exploitation_and_Function_Calling
Category: plugin_exploitation
"""

import argparse
import sys

# VULNERABLE: Allows updating any field
@app.route('/api/users/<int:user_id>', methods=['PUT'])
def update_user(user_id):
    # Get all fields from request
    data = request.json

    # DANGEROUS: Update all provided fields
    db.execute(
        f"UPDATE users SET {', '.join(f'{k}=?' for k in data.keys())} "
        f"WHERE id = ?",
        (*data.values(), user_id)
    )

    return jsonify({'success': True})

# Attack
# PUT /api/users/123
# {"role": "admin", "is_verified": true}

# SECURE: Whitelist allowed fields
@app.route('/api/users/<int:user_id>', methods=['PUT'])
def update_user(user_id):
    data = request.json

    # Only allow specific fields
    allowed_fields = ['display_name', 'email', 'bio']
    update_data = {
        k: v for k, v in data.items() if k in allowed_fields
    }

    if not update_data:
        return jsonify({'error': 'No valid fields'}), 400

    db.execute(
        f"UPDATE users SET {', '.join(f'{k}=?' for k in update_data.keys())} "
        f"WHERE id = ?",
        (*update_data.values(), user_id)
    )

    return jsonify({'success': True})


def main():
    """Command-line interface."""
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--verbose", "-v", action="store_true", help="Verbose output")
    args = parser.parse_args()
    
    # TODO: Add main execution logic
    pass

if __name__ == "__main__":
    main()