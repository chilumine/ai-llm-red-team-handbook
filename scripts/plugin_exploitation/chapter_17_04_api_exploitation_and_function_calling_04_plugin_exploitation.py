#!/usr/bin/env python3
"""
NoSQL injection

Source: Chapter_17_04_API_Exploitation_and_Function_Calling
Category: plugin_exploitation
"""

import argparse
import sys

# VULNERABLE MongoDB query
@app.route('/api/users')
def get_users():
    username = request.args.get('username')
    # Direct use of user input in query
    user = db.users.find_one({'username': username})
    return jsonify(user)

# Attack
# /api/users?username[$ne]=
# MongoDB query: {'username': {'$ne': ''}}
# Returns first user (admin bypass)

# SECURE VERSION
@app.route('/api/users')
def get_users():
    username = request.args.get('username')

    # Validate input type
    if not isinstance(username, str):
        return jsonify({'error': 'Invalid input'}), 400

    # Use strict query
    user = db.users.find_one({'username': {'$eq': username}})
    return jsonify(user)


def main():
    """Command-line interface."""
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--verbose", "-v", action="store_true", help="Verbose output")
    args = parser.parse_args()
    
    # TODO: Add main execution logic
    pass

if __name__ == "__main__":
    main()