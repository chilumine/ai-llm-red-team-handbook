#!/usr/bin/env python3
"""
Real-World Example

Source: Chapter_17_02_API_Authentication_and_Authorization
Category: plugin_exploitation
"""

import argparse
import sys

# Plugin requests Gmail access
oauth = OAuth2Plugin(
    client_id="abc123.apps.googleusercontent.com",
    client_secret=os.environ['GOOGLE_CLIENT_SECRET'],
    redirect_uri="https://myplugin.com/oauth/callback"
)

# Step 1: Redirect user to Google
state = secrets.token_urlsafe(32)
auth_url = oauth.get_authorization_url(
    state=state,
    scope="https://www.googleapis.com/auth/gmail.readonly"
)
return redirect(auth_url)

# Step 2: Handle callback
@app.route('/oauth/callback')
def oauth_callback():
    code = request.args['code']
    state = request.args['state']

    # Verify state (CSRF protection)
    if state != session['oauth_state']:
        abort(403)

    # Exchange code for token
    tokens = oauth.exchange_code_for_token(code)

    # Store tokens securely
    session['access_token'] = tokens['access_token']
    session['refresh_token'] = encrypt(tokens['refresh_token'])

    return "Authorization successful!"

# Step 3: Use token for API requests
@app.route('/read-emails')
def read_emails():
    access_token = session['access_token']

    response = requests.get(
        'https://gmail.googleapis.com/gmail/v1/users/me/messages',
        headers={'Authorization': f'Bearer {access_token}'}
    )

    return response.json()


def main():
    """Command-line interface."""
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--verbose", "-v", action="store_true", help="Verbose output")
    args = parser.parse_args()
    
    # TODO: Add main execution logic
    pass

if __name__ == "__main__":
    main()