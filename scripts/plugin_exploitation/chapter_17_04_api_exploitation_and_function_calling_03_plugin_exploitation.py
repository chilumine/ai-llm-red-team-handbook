#!/usr/bin/env python3
"""
API command injection

Source: Chapter_17_04_API_Exploitation_and_Function_Calling
Category: plugin_exploitation
"""

import subprocess
import re

import argparse
import sys

# Example vulnerable API endpoint
@app.route('/api/ping')
def ping():
    host = request.args.get('host')
    # VULNERABLE
    result = os.popen(f'ping -c 1 {host}').read()
    return jsonify({'result': result})

# Exploit
# /api/ping?host=8.8.8.8;cat /etc/passwd

# SECURE VERSION

@app.route('/api/ping')
def ping():
    host = request.args.get('host')

    # Validate input
    if not re.match(r'^[a-zA-Z0-9.-]+$', host):
        return jsonify({'error': 'Invalid hostname'}), 400

    # Use subprocess with shell=False
    try:
        result = subprocess.run(
            ['ping', '-c', '1', host],
            capture_output=True,
            text=True,
            timeout=5
        )
        return jsonify({'result': result.stdout})
    except:
        return jsonify({'error': 'Ping failed'}), 500


def main():
    """Command-line interface."""
    parser = argparse.ArgumentParser(description=__doc__)
    parser.add_argument("--verbose", "-v", action="store_true", help="Verbose output")
    args = parser.parse_args()
    
    # TODO: Add main execution logic
    pass

if __name__ == "__main__":
    main()